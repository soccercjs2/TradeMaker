<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-ajax.html">
<link rel="import" href="../../bower_components/iron-ajax/iron-request.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../elements/trade-filter/trade-filter.html">

<dom-module id="league-view">
    <template>
        <style>
            /* local DOM styles go here */
            .margined {
                margin: 5px;
            }
        </style>
        <!-- local DOM goes here -->
        <!--url="http://localhost:36880/api/projectionscraper"-->
        <!--url="http://trademakerscraper.azurewebsites.net/api/projectionscraper"-->
        <iron-ajax
            id="projectionAjax"
            url="http://trademakerscraper.azurewebsites.net/api/projectionscraper"
            handle-as="json"
            on-response="_projectionResponse"
            method="GET">
        </iron-ajax>

        <!--url="http://localhost:36880/api/leaguescraper"-->
        <!--url="http://trademakerscraper.azurewebsites.net/api/leaguescraper"-->
        <iron-ajax 
            id="leagueAjax"
            url="http://trademakerscraper.azurewebsites.net/api/leaguescraper"
            handle-as="json"
            content-type="application/json"
            on-response="_leagueResponse"
            method="POST">
        </iron-ajax>

        <paper-dialog id="dialog" class="vertical" modal autoFitOnAttach>
            <h3>Loading Numberfire projections and league data...</h3>
            <center><img src="../../images/ring.gif" /></center>
        </paper-dialog>
        
        <div class="title-text margined" style="font-size: 24px;">{{league.Name}}</div>
        
        <template is="dom-if" if="[[leagueData]]">
            <div class="block margined">Your team: <trade-filter id="myTeamFilter" league-data="[[leagueData]]" primary></trade-filter></div>
            <div class="block margined">Trade partner: <trade-filter id="theirTeamFilter" league-data="[[leagueData]]"></trade-filter></div>
        </template>
        
    </template>
    <script>
        Polymer({
            is: 'league-view',
            properties: {
                leagueid: {
                    type: String,
                    notify: true
                },
                leagues: {
                    type: Array,
                    readonly: true
                },
                league: {
                    type: Object,
                    notify: true,
                    computed: '_getFirebaseLeague(leagues, leagueid)'
                },
                leagueData: {
                    type: Object,
                    notify: true
                }
            },
            _getFirebaseLeague: function (leagues, leagueid) {
                var filteredLeagues = leagues.filter( function(league){return (league.__firebaseKey__ == leagueid);} );
                var leagueFirebase;
                
                if (filteredLeagues) {
                    if (filteredLeagues.length == 1) {
                        leagueFirebase = filteredLeagues[0];
                        this.$['dialog'].open();
                        this.$['projectionAjax'].generateRequest();
                    }
                }

                return leagueFirebase;
            },
            _projectionResponse: function (e) {
                this.$['leagueAjax'].body = { projections: e.detail.response, league: this.league };
                this.$['leagueAjax'].generateRequest();
            },
            _leagueResponse: function (e) {
                this.$['dialog'].close();
                this.dataLoaded = true;
                this.leagueData = e.detail.response;
            }
        });
    </script>
</dom-module>